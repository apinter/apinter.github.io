<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Encrypting files with SOPS, AGE, and Yubikey on atomic systems -</title><meta name=description content="If you’re here, you’re probably looking for a way to store secrets securely. This post isn’t about Kubernetes or managing cluster secrets — it’s about keeping stuff safe locally on your own machine. User-focused.
On a regular mutable system, setting up tools like SOPS and AGE is pretty straightforward. But on atomic/immutable systems (like Fedora Silverblue or openSUSE MicroOS), things get trickier. That’s what I’m tackling here.

Foreword &#128279;
For the past few years I’ve been using CryFS to keep my secrets safe: keys, tokens, backups of my password manager — basically anything private. It worked great, but it started feeling like time to move to something more modern and future-proof."><meta name=author content="Attila Pinter - Adathor"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"YAL\/TB","url":"\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"\/posts\/sops-age-yubikey-sb\/","name":"Encrypting files with sops, age, and yubikey on atomic systems"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Attila Pinter - Adathor"},"headline":"Encrypting files with SOPS, AGE, and Yubikey on atomic systems","description":"If you’re here, you’re probably looking for a way to store secrets securely. This post isn’t about Kubernetes or managing cluster secrets — it’s about keeping stuff safe locally on your own machine. User-focused.\nOn a regular mutable system, setting up tools like SOPS and AGE is pretty straightforward. But on atomic\/immutable systems (like Fedora Silverblue or openSUSE MicroOS), things get trickier. That’s what I’m tackling here.\nForeword \u0026#128279; For the past few years I’ve been using CryFS to keep my secrets safe: keys, tokens, backups of my password manager — basically anything private. It worked great, but it started feeling like time to move to something more modern and future-proof.\n","inLanguage":"en","wordCount":1254,"datePublished":"2025-08-22T01:08:06\u002b07:00","dateModified":"2025-08-22T01:08:06\u002b07:00","image":"\/img\/adathor.png","keywords":["sops, security, yubikey, atomic systems, immutable systems"],"mainEntityOfPage":"\/posts\/sops-age-yubikey-sb\/","publisher":{"@type":"Organization","name":"\/","logo":{"@type":"ImageObject","url":"\/img\/adathor.png","height":60,"width":60}}}</script><meta property="og:title" content="Encrypting files with SOPS, AGE, and Yubikey on atomic systems"><meta property="og:description" content="If you’re here, you’re probably looking for a way to store secrets securely. This post isn’t about Kubernetes or managing cluster secrets — it’s about keeping stuff safe locally on your own machine. User-focused.
On a regular mutable system, setting up tools like SOPS and AGE is pretty straightforward. But on atomic/immutable systems (like Fedora Silverblue or openSUSE MicroOS), things get trickier. That’s what I’m tackling here.

Foreword &#128279;
For the past few years I’ve been using CryFS to keep my secrets safe: keys, tokens, backups of my password manager — basically anything private. It worked great, but it started feeling like time to move to something more modern and future-proof."><meta property="og:image" content="/img/adathor.png"><meta property="og:url" content="/posts/sops-age-yubikey-sb/"><meta property="og:type" content="website"><meta property="og:site_name" content="YAL/TB"><meta name=twitter:title content="Encrypting files with SOPS, AGE, and Yubikey on atomic systems"><meta name=twitter:description content="If you’re here, you’re probably looking for a way to store secrets securely. This post isn’t about Kubernetes or managing cluster secrets — it’s about keeping stuff safe locally on your own machine. …"><meta name=twitter:image content="/img/adathor.png"><meta name=twitter:card content="summary_large_image"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.149.0"><link rel=alternate href=/index.xml type=application/rss+xml title=YAL/TB><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.6.0/css/all.css integrity=sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=/css/syntax.css><link rel=stylesheet href=/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>YAL/TB</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title=YAL/TB href=/><img class=avatar-img src=/img/adathor.png alt=YAL/TB></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Encrypting files with SOPS, AGE, and Yubikey on atomic systems</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-9 col-md-9 col-sm-12"><article role=main class=blog-post><div class="visible-sm visible-xs"><h4>Table of Contents</h4><nav id=TableOfContents><ul><li><a href=#foreword>Foreword</a></li><li><a href=#my-list-of-requirements>My list of requirements</a></li><li><a href=#the-design>The design</a></li><li><a href=#preparing-the-system>Preparing the system</a><ul><li><a href=#quick-summary>Quick summary</a></li></ul></li><li><a href=#configuring-sops>Configuring SOPS</a></li><li><a href=#encrypting-and-decrypting-files>Encrypting and decrypting files</a></li><li><a href=#finalizing-the-setup>Finalizing the setup</a><ul><li><a href=#preparing-the-register-file>Preparing the register file</a></li></ul></li><li><a href=#closing-thoughts>Closing thoughts</a></li></ul></nav></div><p>If you’re here, you’re probably looking for a way to store secrets securely. This post isn’t about Kubernetes or managing cluster secrets — it’s about keeping stuff safe <strong>locally</strong> on your own machine. User-focused.</p><p>On a regular mutable system, setting up tools like SOPS and AGE is pretty straightforward. But on atomic/immutable systems (like Fedora Silverblue or openSUSE MicroOS), things get trickier. That’s what I’m tackling here.</p><hr><h2 id=foreword>Foreword <a class=anchor href=#foreword>&#128279;</a></h2><p>For the past few years I’ve been using <a href=https://www.cryfs.org/><em>CryFS</em></a> to keep my secrets safe: keys, tokens, backups of my password manager — basically anything private. It worked great, but it started feeling like time to move to something more modern and future-proof.</p><p>That’s where <a href=https://github.com/getsops/sops><em>SOPS</em></a> comes in — it integrates multiple encryption solutions under one tool. <a href=https://github.com/FiloSottile/age><em>AGE</em></a> is another piece: simple, modern, with a clean CLI and plugin support. And finally, <a href=https://www.yubico.com/><em>Yubikey</em></a>: a hardware security key that adds extra safety.</p><h2 id=my-list-of-requirements>My list of requirements <a class=anchor href=#my-list-of-requirements>&#128279;</a></h2><ul><li>Modern and future-proof</li><li>Simple and secure</li><li>Open source</li><li>Easy enough to use on atomic systems</li><li>Works across different systems</li><li>Keeps me in full control of my secrets</li><li>No dependency on a third-party service</li></ul><p>Most of this is covered by SOPS + AGE + Yubikey. The tricky part is just making them play nicely on an atomic/immutable host.</p><h2 id=the-design>The design <a class=anchor href=#the-design>&#128279;</a></h2><p>AGE is perfect for creating key pairs to encrypt/decrypt files. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>age-keygen -o mykey.txt
</span></span></code></pre></div><p>That’s simple, but now I’ve just created yet another secret to keep safe. Luckily, I’ve got two Yubikeys, so I can build a redundant setup that avoids crypto-locking myself.</p><p>Here’s the plan:</p><ul><li>Use Yubikeys for everyday encryption/decryption</li><li>Keep an AGE-generated software keypair as a fallback, stored offline (USB drive + password manager copy)</li></ul><p>That way, even if both Yubikeys are lost, I’m not locked out forever.</p><h2 id=preparing-the-system>Preparing the system <a class=anchor href=#preparing-the-system>&#128279;</a></h2><p>I’m currently running <a href=https://fedoraproject.org/atomic-desktops/silverblue/><em>Fedora Silverblue</em></a>. I recently ditched <a href=https://github.com/89luca89/distrobox><em>distrobox</em></a> and went back to devcontainers for development — more secure, more interoperable. So I need this setup to work on the <strong>host</strong> system.</p><p>Back when I was on openSUSE MicroOS, I got into the habit of installing CLI tools with Homebrew, and I’ve stuck with it. Luckily, everything I need is packaged there:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install sops age age-plugin-yubikey
</span></span></code></pre></div><p>That installs SOPS, AGE, and the plugin that connects AGE with the Yubikey.</p><p>But that alone isn’t enough. I don’t want to type my password every time I use the Yubikey, and brew installs don’t live in root’s <code>$PATH</code>. To fix this, I added a <em>polkit</em> rule that lets my user talk to the Yubikey directly:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>nvim</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>etc</span><span style=color:#f92672>/</span><span style=color:#a6e22e>polkit</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>/</span><span style=color:#a6e22e>rules</span>.<span style=color:#a6e22e>d</span><span style=color:#f92672>/</span><span style=color:#ae81ff>10</span><span style=color:#f92672>-</span><span style=color:#a6e22e>pcsc</span><span style=color:#f92672>-</span><span style=color:#a6e22e>custom</span>.<span style=color:#a6e22e>rules</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>polkit</span>.<span style=color:#a6e22e>addRule</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>action</span>, <span style=color:#a6e22e>subject</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>action</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;org.debian.pcsc-lite.access_pcsc&#34;</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>subject</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;myusername&#34;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>polkit</span>.<span style=color:#a6e22e>Result</span>.<span style=color:#a6e22e>YES</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>polkit</span>.<span style=color:#a6e22e>addRule</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>action</span>, <span style=color:#a6e22e>subject</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>action</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;org.debian.pcsc-lite.access_card&#34;</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>.<span style=color:#a6e22e>lookup</span>(<span style=color:#e6db74>&#34;reader&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Yubico YubiKey OTP+FIDO+CCID 00 00&#39;</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>subject</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;myusername&#34;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>polkit</span>.<span style=color:#a6e22e>Result</span>.<span style=color:#a6e22e>YES</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Restart <em>polkit</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart polkit
</span></span></code></pre></div><p>And enable the <em>pcscd</em> service so the Yubikey is ready at boot:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable --now pcscd.service pcscd.socket
</span></span></code></pre></div><p>One more fix: brew-installed packages can’t see the <code>pcscd</code> socket directly. Quick workaround — symlink it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ln -s /run/pcscd/pcscd.comm /home/linuxbrew/.linuxbrew/var/run/pcscd.comm
</span></span></code></pre></div><p>Now the AGE Yubikey plugin works. I can generate a Yubikey-stored keypair:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>age-plugin-yubikey --generate
</span></span></code></pre></div><p>Then save the identity and recipient:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>age-plugin-yubikey --identity &gt;&gt; sops_vault.id
</span></span><span style=display:flex><span>age-plugin-yubikey --list &gt;&gt; yubikey_5NFC.pub
</span></span></code></pre></div><p>This will ask for the PIN and require a Yubikey touch to confirm. Do this twice for both keys. After that, I also generate a fallback software keypair:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>age-keygen -o backup.txt
</span></span></code></pre></div><p>And append it to <code>sops_vault.id</code> so it’s included as a backup option.</p><h3 id=quick-summary>Quick summary <a class=anchor href=#quick-summary>&#128279;</a></h3><p>At this point I have:</p><ul><li>The whole toolchain installed on the host</li><li>Brew packages talking to <code>pcscd</code></li><li>Two Yubikeys each with a keypair</li><li>A fallback software keypair</li><li>A <em>polkit</em> rule that lets my user access the Yubikey without root</li></ul><h2 id=configuring-sops>Configuring SOPS <a class=anchor href=#configuring-sops>&#128279;</a></h2><p>Now with keys ready, time to configure SOPS. Create a <code>.sops.yaml</code> file that tells SOPS which keys to use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># .sops.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>creation_rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>path_regex</span>: <span style=color:#ae81ff>.*/.*</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>age</span>: <span style=color:#e6db74>&#34;age1yubikey1ae5dsekqqmamy29fkr8tccyw8rxl20zl0pgxj7kxzswusuaf0yxs8x56pl,age1yubikey1dvyezkkz763ukzh54g2t6xt9as9h04mcmyujxarwwavrlvvggc5q6hyq00,age1gav0dwax4eejeas4q70g502ps6nvckulhn33nh5k3vv7c3klquvswfnvcr&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>path_regex</span>: <span style=color:#ae81ff>.*</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>age</span>: <span style=color:#e6db74>&#34;age1yubikey1ae5dsekqqmamy29fkr8tccyw8rxl20zl0pgxj7kxzswusuaf0yxs8x56pl,age1yubikey1dvyezkkz763ukzh54g2t6xt9as9h04mcmyujxarwwavrlvvggc5q6hyq00,age1gav0dwax4eejeas4q70g502ps6nvckulhn33nh5k3vv7c3klquvswfnvcr&#34;</span>
</span></span></code></pre></div><p>This tells SOPS to use the AGE keys on the Yubikeys. Both regex rules here match everything — one for directories, one for root files.</p><h2 id=encrypting-and-decrypting-files>Encrypting and decrypting files <a class=anchor href=#encrypting-and-decrypting-files>&#128279;</a></h2><p>SOPS shines with structured formats like YAML/JSON, where I can encrypt individual fields. That’s nice, but in my case I just want <strong>binary in/out</strong>. That’s where the <code>--input-type</code> and <code>--output-type</code> flags are handy.</p><p>Encrypt a file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sops --encrypt --input-type binary --output-type binary --in-place apis
</span></span></code></pre></div><p>Decrypt it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SOPS_AGE_KEY_FILE<span style=color:#f92672>=</span>$PWD/sops_vault sops --decrypt --input-type binary --in-place apis
</span></span></code></pre></div><p>Here, <code>SOPS_AGE_KEY_FILE</code> points to the file with my Yubikey keys, so SOPS knows how to decrypt. The <code>--in-place</code> flag updates the file directly. Without it, SOPS just prints the decrypted content to stdout — useful if I just need to quickly grab my master password.</p><h2 id=finalizing-the-setup>Finalizing the setup <a class=anchor href=#finalizing-the-setup>&#128279;</a></h2><p>This is all great, but I currently I have about 30 different files in this vault, and I really don&rsquo;t feel like typing these commands individually every time I need to access something, or if I want to run the backup job for my password manager. To get around this issue, I&rsquo;ve created a script that can handle both encryption and decryption in one go for all files in the vault and individual files as well. I have created a &ldquo;register&rdquo; file that contains the list of files I want to encrypt/decrypt, and the script will read from this file and process each entry accordingly.</p><p>The script is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>set -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$#<span style=color:#e6db74>&#34;</span> -lt <span style=color:#ae81ff>2</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;Error: Invalid number of arguments.&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COMMAND<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>shift
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span>$COMMAND<span style=color:#e6db74>&#34;</span> in
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>encrypt<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> file in <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      echo <span style=color:#e6db74>&#34;Error: File not found at &#39;</span>$file<span style=color:#e6db74>&#39;. Skipping.&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Encrypting &#39;</span>$file<span style=color:#e6db74>&#39; in-place...&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    sops --encrypt --input-type binary --output-type binary --in-place <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Encryption of &#39;</span>$file<span style=color:#e6db74>&#39; complete.&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>  ;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>decrypt<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> file in <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      echo <span style=color:#e6db74>&#34;Error: File not found at &#39;</span>$file<span style=color:#e6db74>&#39;. Skipping.&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    SOPS_AGE_KEY_FILE<span style=color:#f92672>=</span>$PWD/identity sops --decrypt --input-type binary <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>  ;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>decrypt-inplace<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> file in <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      echo <span style=color:#e6db74>&#34;Error: File not found at &#39;</span>$file<span style=color:#e6db74>&#39;. Skipping.&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    SOPS_AGE_KEY_FILE<span style=color:#f92672>=</span>$PWD/identity sops --decrypt --input-type binary --output-type binary --in-place <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>  ;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>*<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;Error: Unknown command &#39;</span>$COMMAND<span style=color:#e6db74>&#39;.&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  ;;
</span></span><span style=display:flex><span><span style=color:#66d9ef>esac</span>
</span></span></code></pre></div><p>This handles the encryption which is always destructive. The decryption can be a non-destructive way when called with the <code>decrypt</code> option in which case it will print the decrypted content to stdout, or it can be destructive when called with the <code>decrypt-inplace</code> option in which case it will overwrite the file with the decrypted content.</p><h3 id=preparing-the-register-file>Preparing the register file <a class=anchor href=#preparing-the-register-file>&#128279;</a></h3><p>The register is a simple text file containing the relative paths to the files I want to encrypt or decrypt. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># register.txt
</span></span><span style=display:flex><span>file1
</span></span><span style=display:flex><span>file2
</span></span><span style=display:flex><span>file3
</span></span><span style=display:flex><span>folder/file4
</span></span></code></pre></div><p>To combine this file with the sops script I will use the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat register.txt | xargs ./sops.sh encrypt
</span></span></code></pre></div><p>This will read each line from <code>register.txt</code> and pass it as an argument to the <code>sops.sh</code> script for encryption or decryption. Similarly, I can use the same command to decrypt/encrypt the files individually:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>././sops.sh encrypt file1
</span></span><span style=display:flex><span>./sops.sh decrypt file2
</span></span></code></pre></div><h2 id=closing-thoughts>Closing thoughts <a class=anchor href=#closing-thoughts>&#128279;</a></h2><p>With this setup, I’ve got Yubikey-backed encryption working directly on <em>Fedora Silverblue</em>. No root hacks needed after setup, and it should carry over to other atomic/immutable systems, other <em>Linux</em> distributions, and likely compatible with <em>MacOS</em>, and <em>Windows</em> too.</p><p>It’s modern, secure, and doesn’t lock me into a single device or third-party service. Exactly what I wanted.</p><hr><div class=blog-tags><a href=/tags/sops/>sops</a>&nbsp;
<a href=/tags/security/>security</a>&nbsp;
<a href=/tags/yubikey/>yubikey</a>&nbsp;
<a href=/tags/atomic-systems/>atomic systems</a>&nbsp;
<a href=/tags/immutable-systems/>immutable systems</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=/posts/osavs21_microos/ data-toggle=tooltip data-placement=top title="MicroOS for DevOps and automation">&larr; Previous Post</a></li></ul></div><div class="col-lg-3 col-md-3 hidden-sm hidden-xs"><div id=toc-container><h4>Table of Contents</h4><nav id=TableOfContents><ul><li><a href=#foreword>Foreword</a></li><li><a href=#my-list-of-requirements>My list of requirements</a></li><li><a href=#the-design>The design</a></li><li><a href=#preparing-the-system>Preparing the system</a><ul><li><a href=#quick-summary>Quick summary</a></li></ul></li><li><a href=#configuring-sops>Configuring SOPS</a></li><li><a href=#encrypting-and-decrypting-files>Encrypting and decrypting files</a></li><li><a href=#finalizing-the-setup>Finalizing the setup</a><ul><li><a href=#preparing-the-register-file>Preparing the register file</a></li></ul></li><li><a href=#closing-thoughts>Closing thoughts</a></li></ul></nav></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:adathor@adathor.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/apinter title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a rel=me href=https://infosec.exchange/@adathor title=Mastodon><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=adathor.com>Attila Pinter - Adathor</a>
&nbsp;&bull;&nbsp;&copy;
2025
&nbsp;&bull;&nbsp;
<a href=/>YAL/TB</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.149.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=/js/load-photoswipe.js></script></body></html>